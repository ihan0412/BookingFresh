<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>홈 페이지 (인증됨)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; font-weight: bold; }
        .failure { color: red; }
    </style>
</head>
<body>
<h1>환영합니다!</h1>

<div id="status" class="success">로그인 상태 유지 중</div>
<div id="protectedData"></div>

<button onclick="getProtectedData()">보호된 API 데이터 요청</button>
<button onclick="logout()">로그아웃</button>

<script>
    const statusDiv = document.getElementById('status');
    const dataDiv = document.getElementById('protectedData');
    const accessToken = localStorage.getItem('accessToken');

    if (!accessToken) {
        statusDiv.textContent = '토큰이 없습니다. 다시 로그인해 주세요.';
        statusDiv.className = 'failure';
    }

    // 1. 보호된 API에 접근하는 함수
    function getProtectedData() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("Access Token이 로컬 저장소에 없습니다. 로그인을 먼저 해주세요.");
            return;
        }

        fetch('/api/test/protected', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token, // Access Token 전송
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (response.status === 401) {
                    // Access Token 만료 감지 시: 재발급 로직 필요 (현재는 alert)
                    alert("인증 실패 (401). Access Token이 만료되었습니다. 재발급 API를 호출해야 합니다.");
                    return response.text().then(text => dataDiv.textContent = '401 Unauthorized: ' + text);
                }
                return response.text();
            })
            .then(data => {
                dataDiv.textContent = 'API 응답: ' + data;
            })
            .catch(error => {
                dataDiv.textContent = '요청 오류: ' + error;
            });
    }

    // 2. 로그아웃 요청 함수
    function logout() {
        // 서버로 로그아웃 요청 (Refresh Token 삭제 및 쿠키 만료)
        fetch('/api/auth/logout', {
            method: 'POST'
            // Refresh Token은 HttpOnly 쿠키에 있으므로 브라우저가 자동으로 전송
        })
            .then(response => {
                if (response.ok) {
                    // 1. Local Storage에서 Access Token 삭제 (클라이언트 측)
                    localStorage.removeItem('accessToken');

                    alert("로그아웃 성공! Access Token이 삭제되었습니다.");
                    // 2. 로그인 페이지로 리다이렉트
                    window.location.href = '/login';
                } else {
                    alert("로그아웃 실패: 서버 오류 발생");
                }
            })
            .catch(error => {
                alert("네트워크 오류로 로그아웃 실패");
            });
    }
</script>
</body>
</html>