<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>주문/결제</title>
  <link rel="stylesheet" href="/css/order.css">
  <style>
    .order-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
    }
    .section {
      margin-bottom: 32px;
    }
    .section h2 {
      margin-bottom: 16px;
      font-size: 20px;
    }
    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
    }
    .product-list {
      background-color: #fff;
      padding: 16px;
      border: 1px solid #ccc;
    }
    .product-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .total-price {
      font-size: 18px;
      font-weight: bold;
      text-align: right;
      margin-top: 16px;
    }
    .submit-button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #0078ff;
      color: white;
      font-size: 16px;
      border: none;
      cursor: pointer;
      margin-top: 24px;
    }
  </style>
</head>
<body>

<!-- 헤더 fragment -->
<th:block th:replace="fragments/header :: header"></th:block>

<main class="order-container">

  <!-- 배송지 / 구매자 정보 -->
  <section class="section">
    <h2>배송지 / 구매자 정보</h2>

    <div class="form-group">
      <label for="address">주소</label>
      <input type="text" id="address" name="address" required>
    </div>
    <div class="form-group">
      <label for="detail">상세 주소</label>
      <input type="text" id="detail" name="detail">
    </div>
    <div class="form-group">
      <label for="email">이메일</label>
      <input type="email" id="email" name="email">
    </div>

    <!-- 요청사항 -->
    <div class="form-group">
      <label for="request">요청사항</label>
      <textarea id="request" name="request" rows="3"></textarea>
    </div>

    <!-- 상품 리스트 -->
    <section class="section">
      <h2>주문 상품</h2>
      <div class="product-list">
        <div class="product-item" th:each="item : ${orderItems}">
          <span th:text="${item.name}">상품명</span>
        </div>
      </div>
      <div class="total-price" th:text="'총 결제 금액: ₩' + ${totalPrice}">총 결제 금액</div>
    </section>

    <!-- 주문하기 버튼 -->
    <button id="submitOrderBtn" class="submit-button">주문하기</button>

    <div id="orderSuccessModal" style="display:none;
     position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px; border-radius:8px; text-align:center; max-width:300px;">
        <h3>주문이 완료되었습니다!</h3>
        <button id="confirmOrderBtn" style="margin-top:16px; padding:8px 16px;">확인</button>
      </div>
    </div>
  </section>

</main>

<script type="module" th:inline="javascript">
  import { fetchWithAuth } from '/js/common-api.js';

  document.addEventListener("DOMContentLoaded", async () => {
    const orderId = [[${orderId}]]; // ✅ Thymeleaf 값 치환
    const res = await fetchWithAuth(`/orders/${orderId}`, { method: "GET" });
    if (res.ok) {
      const order = await res.json();
      document.querySelector(".product-list").innerHTML =
          order.items.map(item => `<div>${item.name} x ${item.quantity}</div>`).join("");
      document.querySelector(".total-price").textContent =
          `총 결제 금액: ₩${order.finalCost}`;
    }
  });

  document.getElementById("submitOrderBtn").addEventListener("click", async () => {
    const orderId = [[${orderId}]]; // ✅ 동일하게 치환
    const res = await fetchWithAuth(`/orders/${orderId}/complete`, { method: "PATCH" });
    if (res.ok) {
      document.getElementById("orderSuccessModal").style.display = "flex";
    }
  });

  document.getElementById("confirmOrderBtn").addEventListener("click", () => {
    window.location.href = "/index";
  });
</script>

</body>
</html>
