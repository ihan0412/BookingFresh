<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주문 상세 - BOOKING FRESH</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- 공통 CSS -->
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">

  <style>
    .order-detail-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }

    .page-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #00B992;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-header h2 {
      color: #343a40;
      font-weight: 700;
      margin: 0;
    }

    .btn-back {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-back:hover {
      background-color: #5a6268;
      color: white;
    }

    /* 섹션 카드 */
    .section-card {
      background-color: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .section-title {
      color: #00B992;
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e9ecef;
    }

    /* 주문 정보 */
    .order-info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .order-info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #6c757d;
      font-weight: 600;
    }

    .info-value {
      color: #343a40;
      font-weight: 600;
    }

    /* 상품 아이템 */
    .product-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .product-image {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .product-image svg {
      width: 40px;
      height: 40px;
      fill: #6c757d;
    }

    .product-info {
      flex: 1;
    }

    .product-name {
      font-weight: 700;
      color: #343a40;
      margin-bottom: 0.5rem;
    }

    .product-price {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .product-quantity {
      color: #6c757d;
      font-size: 0.9rem;
    }

    /* 가격 정보 */
    .price-row {
      display: flex;
      justify-content: space-between;
      padding: 1rem 0;
      font-size: 1rem;
    }

    .price-row.total {
      border-top: 2px solid #00B992;
      padding-top: 1.5rem;
      margin-top: 1rem;
      font-size: 1.3rem;
      font-weight: 800;
      color: #00B992;
    }

    .price-row.discount {
      color: #dc3545;
    }

    /* 상태 배지 */
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .status-cancelled {
      background-color: #f8d7da;
      color: #842029;
    }

    /* 취소 버튼 */
    .btn-cancel-order {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-cancel-order:hover {
      background-color: #bb2d3b;
      color: white;
    }

    /* 로딩 */
    .loading-spinner {
      text-align: center;
      padding: 3rem;
    }
  </style>
</head>
<body>

<!-- 네비바 포함 -->
<div th:replace="~{fragments/navbar :: headerFragment}"></div>

<!-- 메인 컨텐츠 -->
<main class="main-wrapper">
  <div class="container order-detail-container">

    <div class="page-header">
      <h2 id="order-title">주문 상세</h2>
      <button class="btn-back" onclick="location.href='/mypage'">
        ← 목록으로
      </button>
    </div>

    <div id="order-detail-content">
      <!-- 로딩 중 -->
      <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">주문 정보 로딩 중...</span>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- 공통 JS -->
<script type="module" th:src="@{/js/common-api.js}"></script>
<script type="module" th:src="@{/js/navbar-auth.js}"></script>

<!-- 주문 상세 스크립트 -->
<script type="module">
  import { fetchWithAuth } from '/js/common-api.js';

  // URL에서 주문 ID 추출
  function getOrderIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    return pathParts[pathParts.length - 1];
  }

  // 상태 배지 HTML 생성
  function getStatusBadgeHtml(status) {
    const statusMap = {
      'PENDING': '<span class="status-badge status-pending">대기중</span>',
      'COMPLETED': '<span class="status-badge status-completed">완료됨</span>',
      'CANCELLED': '<span class="status-badge status-cancelled">취소됨</span>'
    };
    return statusMap[status] || '<span class="status-badge">알 수 없음</span>';
  }

  // 주문 상세 렌더링
  function renderOrderDetail(order) {
    const statusBadge = getStatusBadgeHtml(order.status);
    const deliveryType = order.isReservation ? '예약 배송' : '즉시 배송';
    const orderDate = new Date(order.createdAt).toLocaleString('ko-KR');
    const deliveryDate = new Date(order.deliveryDate).toLocaleDateString('ko-KR');

    const deliverySlotText = {
      'MORNING': '오전 (08:00-12:00)',
      'AFTERNOON': '오후 (12:00-18:00)',
      'EVENING': '저녁 (18:00-22:00)'
    }[order.deliverySlot] || '';

    // 할인 금액 계산
    const discountAmount = parseInt(order.totalPrice) - parseInt(order.finalCost);

    // 상품 목록 HTML
    const productsHtml = order.items.map(item => `
                <div class="product-item">
                    <div class="product-image">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
                        </svg>
                    </div>
                    <div class="product-info">
                        <div class="product-name">${item.productName}</div>
                        <div class="product-price">${parseInt(item.price).toLocaleString()}원</div>
                        <div class="product-quantity">수량: ${item.quantity}개</div>
                    </div>
                </div>
            `).join('');

    // 취소 버튼 (대기중 상태일 때만 표시)
    const cancelButton = order.status === 'PENDING'
            ? `<button class="btn-cancel-order w-100 mt-3" onclick="cancelOrder(${order.orderId})">주문 취소</button>`
            : '';

    const html = `
                <!-- 주문 상태 -->
                <div class="section-card">
                    <div class="section-title">주문 정보</div>
                    <div class="order-info-row">
                        <span class="info-label">주문번호</span>
                        <span class="info-value">${order.orderId}</span>
                    </div>
                    <div class="order-info-row">
                        <span class="info-label">주문 상태</span>
                        <span>${statusBadge}</span>
                    </div>
                    <div class="order-info-row">
                        <span class="info-label">주문일시</span>
                        <span class="info-value">${orderDate}</span>
                    </div>
                    <div class="order-info-row">
                        <span class="info-label">주문자</span>
                        <span class="info-value">${order.consumerName}</span>
                    </div>
                </div>

                <!-- 배송 정보 -->
                <div class="section-card">
                    <div class="section-title">배송 정보</div>
                    <div class="order-info-row">
                        <span class="info-label">배송 유형</span>
                        <span class="info-value">${deliveryType}</span>
                    </div>
                    <div class="order-info-row">
                        <span class="info-label">배송 예정일</span>
                        <span class="info-value">${deliveryDate}</span>
                    </div>
                    <div class="order-info-row">
                        <span class="info-label">배송 시간대</span>
                        <span class="info-value">${deliverySlotText}</span>
                    </div>
                </div>

                <!-- 주문 상품 -->
                <div class="section-card">
                    <div class="section-title">주문 상품 (${order.items.length}개)</div>
                    ${productsHtml}
                </div>

                <!-- 결제 정보 -->
                <div class="section-card">
                    <div class="section-title">결제 정보</div>
                    <div class="price-row">
                        <span>상품 금액</span>
                        <span>${parseInt(order.totalPrice).toLocaleString()}원</span>
                    </div>
                    ${discountAmount > 0 ? `
                    <div class="price-row discount">
                        <span>쿠폰 할인</span>
                        <span>-${discountAmount.toLocaleString()}원</span>
                    </div>
                    ` : ''}
                    <div class="price-row total">
                        <span>최종 결제 금액</span>
                        <span>${parseInt(order.finalCost).toLocaleString()}원</span>
                    </div>
                    ${cancelButton}
                </div>
            `;

    document.getElementById('order-detail-content').innerHTML = html;
    document.getElementById('order-title').textContent = `주문 상세 #${order.orderId}`;
  }

  // 주문 상세 로드
  async function loadOrderDetail() {
    const orderId = getOrderIdFromUrl();

    try {
      const response = await fetchWithAuth(`/orders/${orderId}`, {
        method: 'GET'
      });

      const order = await response.json();
      renderOrderDetail(order);

    } catch (error) {
      console.error('주문 상세 로드 실패:', error);
      document.getElementById('order-detail-content').innerHTML = `
                    <div class="section-card text-center">
                        <h4 class="text-danger">주문 정보를 불러올 수 없습니다</h4>
                        <p>${error.message}</p>
                        <button class="btn-back mt-3" onclick="location.href='/mypage'">목록으로</button>
                    </div>
                `;
    }
  }

  // 주문 취소
  window.cancelOrder = async function(orderId) {
    if (!confirm('정말로 이 주문을 취소하시겠습니까?')) {
      return;
    }

    try {
      await fetchWithAuth(`/orders/${orderId}/cancel`, {
        method: 'PATCH'
      });

      alert('주문이 취소되었습니다.');
      loadOrderDetail(); // 페이지 새로고침

    } catch (error) {
      console.error('주문 취소 실패:', error);
      alert('주문 취소에 실패했습니다: ' + error.message);
    }
  };

  // 페이지 로드 시 실행
  document.addEventListener('DOMContentLoaded', loadOrderDetail);
</script>

</body>
</html>