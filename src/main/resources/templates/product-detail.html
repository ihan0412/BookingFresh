<!--
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title th:text="${product.name} + ' - Booking Fresh'">ìƒí’ˆ ìƒì„¸</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">

  <style>
    /* ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .product-detail-layout {
      margin-top: 40px;
    }

    .product-image {
      width: 100%;
      height: 450px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }

    .product-info h2 {
      font-weight: 700;
      font-size: 2rem;
      color: #343a40;
      margin-bottom: 0.5rem;
    }
    .product-info .weight {
      font-size: 1rem;
      color: #6c757d;
      margin-bottom: 1.5rem;
    }
    .product-info .price {
      font-size: 2.25rem;
      font-weight: 800;
      color: #00B992;
      margin-bottom: 2rem;
    }

    /* ìˆ˜ëŸ‰ ë° ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ */
    .purchase-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      border-top: 1px solid #e9ecef;
      padding-top: 2rem;
    }
    .quantity-input {
      width: 80px;
      text-align: center;
    }
    .btn-cart {
      flex-grow: 1;
      background-color: #00B992;
      color: white;
      font-weight: 600;
      padding: 0.75rem;
    }
    .btn-cart:hover {
      background-color: #00897b;
      color: white;
    }
    .btn-wishlist {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #dc3545;
      padding: 0.75rem 1rem;
    }
    .btn-wishlist:hover {
      background-color: #fdd;
    }
    .btn-wishlist.active { /* (â˜…) ì°œ í™œì„±í™” ìŠ¤íƒ€ì¼ */
      background-color: #dc3545;
      color: white;
    }

    /* ì¿ í° ì„¹ì…˜ (coupons.html ìŠ¤íƒ€ì¼ ì°¸ê³ ) */
    .coupon-section {
      margin-top: 2.5rem;
    }
    .coupon-section h5 {
      color: #343a40;
      font-weight: 700;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }
    .coupon-list-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .coupon-info .name {
      font-weight: 600;
      color: #00B992;
    }
    .coupon-info .condition {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .coupon-discount .final-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: #343a40;
    }
  </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: headerFragment}"></div>

<main class="container main-wrapper">

  <div class="row product-detail-layout">

    <div class="col-lg-5">
      <img th:src="${product.photoUrl}" alt="ìƒí’ˆì‚¬ì§„" class="product-image">
    </div>

    <div class="col-lg-7">
      <div class="product-info">

        <h2 th:text="${product.name}">ìƒí’ˆëª…</h2>
        <p class="weight" th:text="${product.weightPieces}">ì¤‘ëŸ‰</p>
        <div class="price" th:text="'â‚©' + ${#numbers.formatInteger(product.price, 0, 'COMMA')}">ê°€ê²©</div>

        &lt;!&ndash;ì´ë¶€ë¶„ ìˆ˜ì • í•„ìš”í•´ë³´ì„&ndash;&gt;
        <form th:action="@{/cart/add}" method="post" class="purchase-actions">
          <input type="hidden" name="productId" th:value="${product.id}">

          <button type="button" class="btn btn-wishlist" id="wishlist-btn" title="ì°œí•˜ê¸°">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
            </svg>
          </button>

          <input type="number" id="quantity" name="quantity" class="form-control quantity-input" min="1" value="1">

          <button type="submit" class="btn btn-cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        </form>

        <div class="coupon-section" th:if="${isLoggedIn}">
          <h5>ğŸ ì ìš© ê°€ëŠ¥ ì¿ í°</h5>
          <div id="coupon-list-container">
            <div class="text-center p-3">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">ì¿ í° ë¡œë”© ì¤‘...</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" th:src="@{/js/common-api.js}"></script>
<script type="module" th:src="@{/js/navbar-auth.js}"></script>

<script type="module" th:inline="javascript">
  import { fetchWithAuth } from '/js/common-api.js';

  // (1) ì„œë²„(SSR)ì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœì™€ ìƒí’ˆ IDë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
  const isLoggedIn = /*[[${isLoggedIn}]]*/ false;
  const productId = /*[[${product.id}]]*/ null;
  const productPrice = /*[[${product.price}]]*/ 0;

  // (2) í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener("DOMContentLoaded", () => {

    // (3) ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì¿ í° API í˜¸ì¶œ
    if (isLoggedIn) {
      loadApplicableCoupons();
    }

    // (4) ì¢‹ì•„ìš” ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const wishlistBtn = document.getElementById('wishlist-btn');
    wishlistBtn.addEventListener('click', () => {
      // (â˜…) ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
      if (!isLoggedIn) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
        location.href = '/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      } else {
        // (â˜…) ë¡œê·¸ì¸ ì‹œ: 1ë‹¨ê³„ì—ì„œ ìˆ˜ì •í•œ "ì¢‹ì•„ìš”" API í˜¸ì¶œ
        handleLikeProduct();
      }
    });
  });

  // (5) ìƒí’ˆì— ì ìš© ê°€ëŠ¥í•œ ì¿ í° ë¡œë“œ í•¨ìˆ˜ (CSR)
  async function loadApplicableCoupons() {
    const container = document.getElementById('coupon-list-container');
    try {
      // (â˜…) 1ë‹¨ê³„ì—ì„œ ë§Œë“  ìƒˆ API í˜¸ì¶œ
      const response = await fetchWithAuth(`/api/coupons/applicable-to/${productId}`);
      const coupons = await response.json();

      if (coupons.length === 0) {
        container.innerHTML = `<div class="text-muted p-3">ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      // (â˜…) ì¿ í° ëª©ë¡ ë Œë”ë§ (ì´ ë¶€ë¶„ì„ ìˆ˜ì •)
      container.innerHTML = coupons.map(coupon => `
        <div class="coupon-list-item">
          <div class="coupon-info">
            <div class="name">${coupon.name}</div>
            <div class="condition">${coupon.minOrderAmount}ì› ì´ìƒ êµ¬ë§¤ ì‹œ</div>
          </div>
          <div class="coupon-discount">

            <span class="final-price">
              ${parseInt(coupon.finalPriceAfterDiscount).toLocaleString()}ì›
            </span>
            <small class="text-danger ms-1">(-${parseInt(coupon.calculatedDiscountAmount).toLocaleString()}ì›)</small>

          </div>
        </div>
      `).join('');

    } catch (error) {
      console.error('ì¿ í° ë¡œë“œ ì‹¤íŒ¨:', error);
      container.innerHTML = `<div class="text-danger p-3">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
    }
  }

  // (6) (â˜…) "ì¢‹ì•„ìš”" API í˜¸ì¶œ í•¨ìˆ˜
  async function handleLikeProduct() {
    const wishlistBtn = document.getElementById('wishlist-btn');
    try {
      // (â˜…) 1ë‹¨ê³„ì—ì„œ ìˆ˜ì •í•œ /products/{id}/like API í˜¸ì¶œ
      const response = await fetchWithAuth(`/products/${productId}/like`, {
        method: 'POST'
      });

      wishlistBtn.classList.add('active'); // (â˜…) ì°œ ë²„íŠ¼ í™œì„±í™”
      alert('ìƒí’ˆì„ ì°œí–ˆìŠµë‹ˆë‹¤!');

    } catch (error) {
      console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:', error);
      // (â˜…) ProductLikeServiceì˜ "ì´ë¯¸ ì¢‹ì•„ìš”í•œ ìƒí’ˆ" ì˜¤ë¥˜ ì²˜ë¦¬
      if (error.message.includes("ì´ë¯¸ ì¢‹ì•„ìš”")) {
        // (â˜…) ì´ë¯¸ ì°œí•œ ê²½ìš°, ì°œ ì·¨ì†Œ(DELETE) API í˜¸ì¶œ
        if (confirm('ì´ë¯¸ ì°œí•œ ìƒí’ˆì…ë‹ˆë‹¤. ì°œì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          await handleUnlikeProduct();
        }
      } else {
        alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
  }

  // (7) (â˜…) "ì¢‹ì•„ìš” ì·¨ì†Œ" API í˜¸ì¶œ í•¨ìˆ˜ (ì¶”ê°€)
  async function handleUnlikeProduct() {
    const wishlistBtn = document.getElementById('wishlist-btn');
    try {
      // (â˜…) 1ë‹¨ê³„ì—ì„œ ìˆ˜ì •í•œ /products/{id}/like API í˜¸ì¶œ
      await fetchWithAuth(`/products/${productId}/like`, {
        method: 'DELETE'
      });

      wishlistBtn.classList.remove('active'); // (â˜…) ì°œ ë²„íŠ¼ ë¹„í™œì„±í™”
      alert('ì°œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');

    } catch (error) {
      console.error('ì¢‹ì•„ìš” ì·¨ì†Œ ì‹¤íŒ¨:', error);
      alert('ì¢‹ì•„ìš” ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

</script>

</body>
</html>-->


<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>ìƒí’ˆ ìƒì„¸</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>

<!-- í—¤ë” í¬í•¨ -->
<th:block th:replace="fragments/header :: header"></th:block>

<main class="container">

  <!-- âœ… ìƒí’ˆ ì´ë¯¸ì§€ ì˜ì—­ -->
  <section class="product-images">
    <img th:src="${product.photoUrl}" alt="ìƒí’ˆì‚¬ì§„" class="product-image">
  </section>

  <!-- âœ… ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
  <section class="product-info">
    <h2 th:text="${product.name}">ìƒí’ˆëª…</h2>
    <p th:text="'ì¤‘ëŸ‰: ' + ${product.weightPieces}">ì¤‘ëŸ‰</p>
    <p th:text="'ê°€ê²©: â‚©' + ${product.price}">ê°€ê²©</p>
  </section>

  <!-- âœ… ë¬¶ìŒ ì˜µì…˜ ì„ íƒ -->
  <section class="bundle-options">
    <label for="bundle">ë¬¶ìŒ ì„ íƒ:</label>
    <select id="bundle" name="bundle">
      <option value="1">1ê°œ</option>
      <option value="2">2ê°œ</option>
      <option value="3">3ê°œ</option>
      <option value="6">6ê°œ</option>
    </select>
    <p id="bundle-price">ì´ ê°€ê²©: â‚©10,740</p> <!-- ì´ˆê¸°ê°’ì€ product.price -->
  </section>


  <section class="purchase-actions">
    <!-- ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ -->
    <label for="quantity">ìˆ˜ëŸ‰:</label>
    <input type="number" id="quantity" name="quantity" min="1" value="1">

    <!-- ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ -->
    <button id="addToCartBtn" th:attr="data-product-id=${product.id}">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
  </section>

</main>

<!--&lt;!&ndash; í‘¸í„° í¬í•¨ &ndash;&gt;-->
<!--<th:block th:replace="fragments/footer :: footer"></th:block>-->
<script type="module">
  import { fetchWithAuth } from '/js/common-api.js';

  document.getElementById("addToCartBtn").addEventListener("click", async (e) => {
    const productId = e.target.dataset.productId;
    const quantity = document.getElementById("quantity").value; // âœ… ìˆ˜ëŸ‰ ì…ë ¥ê°’ ì½ê¸°

    try {
      const response = await fetchWithAuth(`/api/cart/add?productId=${productId}&quantity=${quantity}`, {
        method: "POST"
      });

      if (response.ok) {
        alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
      } else {
        window.location.href = "/login";
      }
    } catch (err) {
      alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
      window.location.href = "/login";
    }
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const bundleSelect = document.getElementById("bundle");       // ë¬¶ìŒ ì˜µì…˜
    const quantityInput = document.getElementById("quantity");    // ìˆ˜ëŸ‰ ì…ë ¥
    const priceDisplay = document.getElementById("bundle-price"); // ì´ ê°€ê²© í‘œì‹œ ì˜ì—­

    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë‹¨ì¼ ìƒí’ˆ ê°€ê²© (Thymeleafê°€ ìˆ«ìë¡œ ì¹˜í™˜)
    const unitPrice = /*[[${product.price}]]*/ 10740;

    function updatePrice() {
      const bundleCount = parseInt(bundleSelect.value);   // ë¬¶ìŒ ì˜µì…˜ ê°’
      const quantity = parseInt(quantityInput.value);     // ìˆ˜ëŸ‰ ì…ë ¥ ê°’
      const totalPrice = unitPrice * bundleCount * quantity; // ì´ ê°€ê²© ê³„ì‚°

      priceDisplay.textContent = `ì´ ê°€ê²©: â‚©${totalPrice.toLocaleString()}`;
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bundleSelect.addEventListener("change", updatePrice);
    quantityInput.addEventListener("input", updatePrice);

    // ì´ˆê¸° ë Œë”ë§ ì‹œ ê°€ê²© ì„¤ì •
    updatePrice();
  });
</script>
</body>


</html>