<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>상품 상세</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>

<!-- 헤더 포함 -->
<th:block th:replace="fragments/header :: header"></th:block>

<main class="container">

  <!-- ✅ 상품 이미지 영역 -->
  <section class="product-images">
    <img th:src="${product.photoUrl}" alt="상품사진" class="product-image">
  </section>

  <!-- ✅ 상품 정보 영역 -->
  <section class="product-info">
    <h2 th:text="${product.name}">상품명</h2>
    <p th:text="'중량: ' + ${product.weightPieces}">중량</p>
    <p th:text="'가격: ₩' + ${product.price}">가격</p>
  </section>

  <!-- ✅ 묶음 옵션 선택 -->
  <section class="bundle-options">
    <label for="bundle">묶음 선택:</label>
    <select id="bundle" name="bundle">
      <option value="1">1개</option>
      <option value="2">2개</option>
      <option value="3">3개</option>
      <option value="6">6개</option>
    </select>
    <p id="bundle-price">총 가격: ₩10,740</p> <!-- 초기값은 product.price -->
  </section>


  <section class="purchase-actions">
    <!-- 수량 입력 필드 -->
    <label for="quantity">수량:</label>
    <input type="number" id="quantity" name="quantity" min="1" value="1">

    <!-- 장바구니 버튼 -->
    <button id="addToCartBtn" th:attr="data-product-id=${product.id}">장바구니 담기</button>
  </section>

</main>

<!--&lt;!&ndash; 푸터 포함 &ndash;&gt;-->
<!--<th:block th:replace="fragments/footer :: footer"></th:block>-->
<script type="module">
  import { fetchWithAuth } from '/js/common-api.js';

  document.getElementById("addToCartBtn").addEventListener("click", async (e) => {
    const productId = e.target.dataset.productId;
    const quantity = document.getElementById("quantity").value; // ✅ 수량 입력값 읽기

    try {
      const response = await fetchWithAuth(`/api/cart/add?productId=${productId}&quantity=${quantity}`, {
        method: "POST"
      });

      if (response.ok) {
        alert("장바구니에 담았습니다!");
        window.location.href = "/products"
      } else {
        window.location.href = "/login";
      }
    } catch (err) {
      alert("세션이 만료되었습니다. 다시 로그인해주세요.");
      window.location.href = "/login";
    }
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const bundleSelect = document.getElementById("bundle");       // 묶음 옵션
    const quantityInput = document.getElementById("quantity");    // 수량 입력
    const priceDisplay = document.getElementById("bundle-price"); // 총 가격 표시 영역

    // 서버에서 전달된 단일 상품 가격 (Thymeleaf가 숫자로 치환)
    const unitPrice = /*[[${product.price}]]*/ 10740;

    function updatePrice() {
      const bundleCount = parseInt(bundleSelect.value);   // 묶음 옵션 값
      const quantity = parseInt(quantityInput.value);     // 수량 입력 값
      const totalPrice = unitPrice * bundleCount * quantity; // 총 가격 계산

      priceDisplay.textContent = `총 가격: ₩${totalPrice.toLocaleString()}`;
    }

    // 이벤트 바인딩
    bundleSelect.addEventListener("change", updatePrice);
    quantityInput.addEventListener("input", updatePrice);

    // 초기 렌더링 시 가격 설정
    updatePrice();
  });
</script>
</body>


</html>
